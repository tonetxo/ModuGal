---
import LanguageSwitcher from '../components/LanguageSwitcher.astro';

interface Props {
	title: string;
}

const { title } = Astro.props;
---
<!doctype html>
<html lang="gl">
	<head>
		<meta charset="UTF-8" />
		<meta name="description" content="O obradoiro do inventor sÃ³nico." data-i18n-key="page.description" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="generator" content={Astro.generator} />
		<title data-i18n-key="page.title">{title}</title>

		<!-- Google Fonts -->
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Source+Sans+Pro:wght@400;600&display=swap" rel="stylesheet">
	</head>
	<body>
    <div class="sound-controls">
      <button id="mute-button" title="Silenciar / Activar Sonido">
        <svg id="icon-unmuted" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg>
        <svg id="icon-muted" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="display: none;"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"></path></svg>
      </button>
    </div>
    <LanguageSwitcher />
		<slot />
	</body>
</html>

<style is:global>
  @font-face { font-family: 'Castelao'; src: url('/fonts/Castelao.woff2') format('woff2'); font-weight: normal; font-style: normal; font-display: swap; }
	:root { --color-base: #2a2a2a; --color-text: #e0e0e0; --color-accent-1: #b87333; --color-accent-2: #e1c16e; --font-family-headings: 'Playfair Display', serif; --font-family-body: 'Source Sans Pro', sans-serif; }
	html { font-family: var(--font-family-body); background-color: var(--color-base); color: var(--color-text); }
	body { margin: 0; box-sizing: border-box; min-height: 100vh; display: flex; align-items: center; justify-content: center; }
	h1, h2, h3, h4 { font-family: var(--font-family-headings); color: var(--color-accent-2); margin: 0; }
  .sound-controls {
    position: fixed;
    top: 1rem;
    left: 1rem;
    z-index: 100;
  }
  #mute-button {
    background: transparent;
    border: 1px solid var(--color-accent-2);
    color: var(--color-accent-2);
    cursor: pointer;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 0.7;
    transition: all 0.2s ease;
  }
  #mute-button:hover {
    opacity: 1;
    background-color: var(--color-accent-2);
    color: var(--color-base);
  }
  #mute-button svg {
    width: 24px;
    height: 24px;
  }
</style>

<script>
  // This script now runs on every page that uses this layout.
  document.addEventListener('DOMContentLoaded', () => {
    let audioContext;
    let masterGain;
    let loopSource;
    let isMuted = false;
    let isPlaying = false;

    const muteButton = document.getElementById('mute-button');
    const iconUnmuted = document.getElementById('icon-unmuted');
    const iconMuted = document.getElementById('icon-muted');

    // Function to initialize and start the audio on first user interaction
    async function initAudio() {
      if (isPlaying || !muteButton) return;
      
      // Create AudioContext
      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      } catch (e) {
        console.error('Web Audio API is not supported');
        return;
      }

      // Create master gain for the loop
      masterGain = audioContext.createGain();
      masterGain.gain.value = 0.5; // Start at 50% volume
      masterGain.connect(audioContext.destination);

      // Fetch and decode audio
      try {
        const response = await fetch('/audio/loop.mp3');
        const arrayBuffer = await response.arrayBuffer();
        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

        // Create and configure loop source
        loopSource = audioContext.createBufferSource();
        loopSource.buffer = audioBuffer;
        loopSource.loop = true;
        loopSource.connect(masterGain);
        loopSource.start(0);
        isPlaying = true;
      } catch (e) {
        console.error('Error loading or playing audio file:', e);
        // Hide button if audio fails to load
        muteButton.style.display = 'none';
      }
    }

    // Mute/unmute logic
    if (muteButton && iconUnmuted && iconMuted) {
      muteButton.addEventListener('click', () => {
        // Initialize audio on the first click if it hasn't started
        if (!isPlaying) {
          initAudio();
        }

        if (!masterGain) return;

        isMuted = !isMuted;
        if (isMuted) {
          masterGain.gain.setTargetAtTime(0, audioContext.currentTime, 0.1);
          iconUnmuted.style.display = 'none';
          iconMuted.style.display = 'block';
        } else {
          masterGain.gain.setTargetAtTime(0.5, audioContext.currentTime, 0.1);
          iconUnmuted.style.display = 'block';
          iconMuted.style.display = 'none';
        }
      });
    }
  });
</script>
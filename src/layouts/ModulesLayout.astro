---
import Layout from "./Layout.astro";
import { useTranslations } from "../i18n/utils";
import { getEntry } from "astro:content";
import { ui } from "../i18n/ui";
import "../styles/modules.css";

interface Props {
  lang: keyof typeof ui;
  entryId: string;
}

const { lang, entryId } = Astro.props;
const t = useTranslations(lang);

// Fetch content using Content Collections
const entry = await getEntry("modules", entryId);

if (!entry) {
  throw new Error(`Module entry ${entryId} not found.`);
}

const { Content, headings } = await entry.render();

// Filter headings for sidebar (only H2)
const categories = headings.filter((h) => h.depth === 2);
---

<Layout title={t("nav.modules")}>
  <main class="page-content">
    <h1 data-i18n-key="nav.modules">{t("nav.modules")}</h1>

    <div class="modules-container">
      <aside class="modules-sidebar">
        <h2 class="sidebar-title" data-i18n-key="modules_menu.title">
          {t("modules_menu.title")}
        </h2>
        <nav>
          <ul>
            {
              categories.map((category) => (
                <li>
                  <a href={`#${category.slug}`}>{category.text}</a>
                </li>
              ))
            }
          </ul>
        </nav>
      </aside>
      <section class="modules-content">
        <div class="markdown-content">
          <Content />
        </div>
      </section>
    </div>
  </main>

  <script>
    const initSidebar = () => {
      // Add smooth scrolling for sidebar navigation links
      const sidebarLinks = document.querySelectorAll(".modules-sidebar nav a");

      sidebarLinks.forEach((link) => {
        link.addEventListener("click", function (e) {
          e.preventDefault();

          const href = this.getAttribute("href");
          if (!href) return;

          const targetId = href.substring(1);
          const targetElement = document.getElementById(targetId);

          if (targetElement) {
            // Calculate offset to account for fixed elements
            const offsetTop = targetElement.offsetTop - 100;

            window.scrollTo({
              top: offsetTop,
              behavior: "smooth",
            });

            // Update active link logic
            setTimeout(() => {
              sidebarLinks.forEach((l) => l.classList.remove("active"));
              this.classList.add("active");
            }, 300);
          }
        });
      });

      // Add active link highlighting based on scroll position
      const observerOptions = {
        root: null,
        rootMargin: "-20% 0px -80% 0px", // Trigger when element is in top 20% of viewport
        threshold: 0,
      };

      const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            sidebarLinks.forEach((link) => link.classList.remove("active"));

            try {
              const safeId = CSS.escape(entry.target.id);
              const activeLink = document.querySelector(
                `.modules-sidebar nav a[href="#${safeId}"]`
              );
              if (activeLink) {
                activeLink.classList.add("active");
              }
            } catch (e) {
              console.warn("Invalid ID for selector:", entry.target.id);
            }
          }
        });
      }, observerOptions);

      // Observe all h2 elements in the content that have IDs
      document.querySelectorAll(".markdown-content h2[id]").forEach((h2) => {
        observer.observe(h2);
      });
    };

    // Initialize on every page load (View Transitions compatible)
    document.addEventListener("astro:page-load", initSidebar);
  </script>
</Layout>